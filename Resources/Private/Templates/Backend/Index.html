<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Backend/Default" />

<f:section name="Content">

<f:be.pageRenderer
    includeJavaScriptModules="{0: '@pahy/ignitercf/backend-module.js'}"
    includeCssFiles="{0: 'EXT:ignitercf/Resources/Public/Css/backend-module.css'}"
/>

<div class="ignitercf-module">
    <h1>
        <core:icon identifier="module-ignitercf" size="medium" />
        IgniterCF - Cloudflare Cache Management
    </h1>

    <!-- Global Status -->
    <f:if condition="{globalSettings.enabled}">
        <f:then>
            <f:if condition="{allConfigured}">
                <f:then>
                    <div class="callout callout-success">
                        <div class="media">
                            <div class="media-left">
                                <core:icon identifier="actions-check" size="small" />
                            </div>
                            <div class="media-body">
                                <h4 class="callout-title">All sites configured</h4>
                                <p class="callout-body">Cloudflare integration is active for all sites.</p>
                            </div>
                        </div>
                    </div>
                </f:then>
                <f:else>
                    <div class="callout callout-warning">
                        <div class="media">
                            <div class="media-left">
                                <core:icon identifier="actions-exclamation-triangle" size="small" />
                            </div>
                            <div class="media-body">
                                <h4 class="callout-title">Configuration required</h4>
                                <p class="callout-body">Some sites are not fully configured. See details below.</p>
                            </div>
                        </div>
                    </div>
                </f:else>
            </f:if>
        </f:then>
        <f:else>
            <div class="callout callout-danger">
                <div class="media">
                    <div class="media-left">
                        <core:icon identifier="actions-ban" size="small" />
                    </div>
                    <div class="media-body">
                        <h4 class="callout-title">Extension disabled</h4>
                        <p class="callout-body">
                            IgniterCF is globally disabled. Enable it in
                            <strong>Settings → Extension Configuration → ignitercf</strong>.
                        </p>
                    </div>
                </div>
            </div>
        </f:else>
    </f:if>

    <!-- Sites Configuration Status -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <core:icon identifier="apps-pagetree-root" size="small" />
                Site Configuration Status
            </h3>
        </div>
        <div class="panel-body">
            <f:if condition="{sitesStatus}">
                <f:then>
                    <f:for each="{sitesStatus}" as="site" key="identifier">
                        <f:render partial="Backend/SiteStatus" arguments="{site: site}" />
                    </f:for>
                </f:then>
                <f:else>
                    <p class="text-muted">No sites configured in TYPO3.</p>
                </f:else>
            </f:if>
        </div>
    </div>

    <!-- Statistics -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <core:icon identifier="content-widget-chart-bar" size="small" />
                Statistics (Last {statisticsDays} Days)
            </h3>
            <f:form action="saveDays" method="post" style="display: inline;">
                <f:form.hidden name="setting" value="statisticsDays" />
                <f:form.select
                    name="days"
                    options="{availableDays}"
                    value="{statisticsDays}"
                    additionalAttributes="{onchange: 'this.form.submit()'}"
                    class="form-select form-select-sm"
                />
            </f:form>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="ignitercf-stat-card stat-total">
                        <div class="stat-value">{statistics.total}</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="ignitercf-stat-card stat-success">
                        <div class="stat-value">{statistics.success}</div>
                        <div class="stat-label">Successful</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="ignitercf-stat-card stat-errors">
                        <div class="stat-value">{statistics.errors}</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Chart -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <core:icon identifier="content-widget-chart-bar" size="small" />
                Purge Activity (Last {chartDays} Days)
                <f:if condition="{chartDataAge}">
                    <small class="text-muted" style="font-weight: normal; margin-left: 0.5rem;">
                        · updated {chartDataAge} min ago
                    </small>
                </f:if>
            </h3>
            <f:form action="saveDays" method="post" style="display: inline;">
                <f:form.hidden name="setting" value="chartDays" />
                <f:form.select
                    name="days"
                    options="{availableDays}"
                    value="{chartDays}"
                    additionalAttributes="{onchange: 'this.form.submit()'}"
                    class="form-select form-select-sm"
                />
            </f:form>
        </div>
        <div class="panel-body">
            <div class="ignitercf-chart-wrapper">
                <canvas id="ignitercf-activity-chart"></canvas>
            </div>
            <p id="ignitercf-chart-nodata" class="text-muted text-center" style="display: none;">
                No data available. Run the chart:generate command first.
            </p>
            <p class="text-muted text-center" style="margin-top: 0.5rem; margin-bottom: 0;">
                <small>
                    <core:icon identifier="actions-terminal" size="small" />
                    <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">vendor/bin/typo3 ignitercf:chart:generate</code>
                </small>
            </p>
        </div>
    </div>

    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        (function() {
            const chartData = <f:format.raw>{chartDataJson}</f:format.raw>;
            const chartWrapper = document.querySelector('.ignitercf-chart-wrapper');
            const noDataMessage = document.getElementById('ignitercf-chart-nodata');

            if (!chartData || chartData.length === 0) {
                if (chartWrapper) chartWrapper.style.display = 'none';
                if (noDataMessage) noDataMessage.style.display = 'block';
                return;
            }

            const labels = chartData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' });
            });
            const successData = chartData.map(d => d.success);
            const errorData = chartData.map(d => d.errors);

            const ctx = document.getElementById('ignitercf-activity-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Successful',
                            data: successData,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1,
                            borderRadius: 2
                        },
                        {
                            label: 'Errors',
                            data: errorData,
                            backgroundColor: 'rgba(220, 53, 69, 0.8)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1,
                            borderRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const avgResponse = chartData[dataIndex].avg_response_ms;
                                    return 'Avg Response: ' + avgResponse.toFixed(0) + ' ms';
                                }
                            }
                        }
                    }
                }
            });
        })();
    </script>

    <!-- Recent Log Entries -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <core:icon identifier="actions-document-view" size="small" />
                Recent Log Entries
            </h3>
        </div>
        <div class="panel-body" style="padding: 0;">
            <f:if condition="{recentLogs}">
                <f:then>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Type</th>
                                    <th>Site</th>
                                    <th>URLs</th>
                                    <th>Status</th>
                                    <th>Response</th>
                                </tr>
                            </thead>
                            <tbody>
                                <f:for each="{recentLogs}" as="log">
                                    <tr class="{f:if(condition: log.success, then: '', else: 'table-danger')}">
                                        <td><small class="text-muted">{log.timestamp}</small></td>
                                        <td>
                                            <f:if condition="{log.type} == 'purge_everything'">
                                                <f:then>
                                                    <span class="badge" style="background: var(--ignitercf-orange); color: #fff;">Purge All</span>
                                                </f:then>
                                                <f:else>
                                                    <span class="badge badge-info">Purge URLs</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                        <td><strong>{log.site}</strong></td>
                                        <td>
                                            <f:if condition="{log.urls_count}">
                                                <f:then>{log.urls_count}</f:then>
                                                <f:else>–</f:else>
                                            </f:if>
                                        </td>
                                        <td>
                                            <f:if condition="{log.success}">
                                                <f:then>
                                                    <span class="badge badge-success">
                                                        <core:icon identifier="actions-check" size="small" /> OK
                                                    </span>
                                                </f:then>
                                                <f:else>
                                                    <span class="badge badge-danger" title="{log.error}">
                                                        <core:icon identifier="actions-ban" size="small" /> Error
                                                    </span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                        <td><f:format.number decimals="0">{log.response_time_ms}</f:format.number> ms</td>
                                    </tr>
                                </f:for>
                            </tbody>
                        </table>
                    </div>
                </f:then>
                <f:else>
                    <div style="padding: 16px;">
                        <p class="text-muted mb-0">
                            No log entries yet.
                            <f:if condition="{globalSettings.logLevel} == 'none'">
                                <br /><em>Note: Logging is currently disabled.</em>
                            </f:if>
                        </p>
                    </div>
                </f:else>
            </f:if>
        </div>
    </div>

    <!-- Global Settings Info -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <core:icon identifier="actions-cog" size="small" />
                Current Settings
            </h3>
        </div>
        <div class="panel-body">
            <dl class="ignitercf-settings">
                <dt>Extension Enabled</dt>
                <dd>
                    <f:if condition="{globalSettings.enabled}">
                        <f:then><span class="badge badge-success">Yes</span></f:then>
                        <f:else><span class="badge badge-danger">No</span></f:else>
                    </f:if>
                </dd>

                <dt>Auto-Purge on Save</dt>
                <dd>
                    <f:if condition="{globalSettings.autoPurgeOnSave}">
                        <f:then><span class="badge badge-success">Yes</span></f:then>
                        <f:else><span class="badge badge-secondary">No</span></f:else>
                    </f:if>
                </dd>

                <dt>Purge on Clear All</dt>
                <dd>
                    <f:if condition="{globalSettings.purgeOnClearAll}">
                        <f:then><span class="badge badge-success">Yes</span></f:then>
                        <f:else><span class="badge badge-secondary">No</span></f:else>
                    </f:if>
                </dd>

                <dt>Cache-Control Middleware</dt>
                <dd>
                    <f:if condition="{globalSettings.middlewareEnabled}">
                        <f:then><span class="badge badge-success">Enabled</span></f:then>
                        <f:else><span class="badge badge-secondary">Disabled</span></f:else>
                    </f:if>
                </dd>

                <dt>Log Level</dt>
                <dd><code>{globalSettings.logLevel}</code></dd>

                <dt>Log Retention</dt>
                <dd>
                    <f:if condition="{globalSettings.logRetentionDays}">
                        <f:then>{globalSettings.logRetentionDays} days</f:then>
                        <f:else>Indefinite</f:else>
                    </f:if>
                </dd>
            </dl>
            <p class="text-muted mb-0" style="margin-top: 1rem;">
                <small>
                    <core:icon identifier="actions-cog" size="small" />
                    Change settings in <strong>Settings → Extension Configuration → ignitercf</strong>
                </small>
            </p>
        </div>
    </div>

</div>

</f:section>

</html>
